<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnimalPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TTPC-GES</a> &gt; <a href="index.source.html" class="el_package">com.ttpc.ges.view</a> &gt; <span class="el_source">AnimalPanel.java</span></div><h1>AnimalPanel.java</h1><pre class="source lang-java linenums">package com.ttpc.ges.view;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;
import javax.swing.text.AbstractDocument;
import javax.swing.text.AttributeSet;
import javax.swing.text.BadLocationException;
import javax.swing.text.DocumentFilter;

import com.ttpc.ges.components.TTPCButton;
import com.ttpc.ges.components.TTPCComboBox;
import com.ttpc.ges.components.TTPCDialogMouvement;
import com.ttpc.ges.components.TTPCTextField;
import com.ttpc.ges.model.Animal;
import com.ttpc.ges.model.DatabaseManager;
import com.ttpc.ges.model.Mouvement;

import java.awt.*;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.util.List;

public class AnimalPanel extends JPanel {
    private final DatabaseManager dbManager;
    private TTPCTextField nomField, especeField, provenanceField, searchField, numeroIdField;
    private JTextArea descriptionArea;
    private TTPCComboBox&lt;String&gt; sexeBox;
    private JSpinner ageSpinner;
    private JTable table;
    private DefaultTableModel tableModel;
    private TableRowSorter&lt;DefaultTableModel&gt; sorter;
    private JPanel formWrapper;
    private JSplitPane splitPane;
    private TTPCButton addButton,editButton, deleteButton, voirMouvementsButton; 
    private JButton importButton, exportButton, toggleFormButton;
<span class="fc" id="L41">    private Color blueColor = new Color(188,218,244);</span>

<span class="fc" id="L43">    public AnimalPanel(DatabaseManager dbManager) {</span>
<span class="fc" id="L44">        this.dbManager = dbManager;</span>
<span class="fc" id="L45">        setLayout(new BorderLayout());</span>
        
<span class="fc" id="L47">        UIManager.put(&quot;Label.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L48">        UIManager.put(&quot;TextField.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L49">        UIManager.put(&quot;TextArea.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L50">        UIManager.put(&quot;CheckBox.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L51">        UIManager.put(&quot;ComboBox.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L52">        UIManager.put(&quot;Button.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>
<span class="fc" id="L53">        UIManager.put(&quot;Spinner.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 14));</span>

        // Table : contenu des cellules
<span class="fc" id="L56">        UIManager.put(&quot;Table.font&quot;, new Font(&quot;SansSerif&quot;, Font.PLAIN, 13));</span>

        // Table : en-têtes de colonnes
<span class="fc" id="L59">        UIManager.put(&quot;TableHeader.font&quot;, new Font(&quot;SansSerif&quot;, Font.BOLD, 14));</span>

        // === Formulaire ===
<span class="fc" id="L62">        JPanel formPanel = new JPanel(new GridLayout(0, 2, 10, 10));</span>
<span class="fc" id="L63">        formPanel.setBorder(BorderFactory.createTitledBorder(&quot;Ajouter un animal&quot;));</span>
<span class="fc" id="L64">        formPanel.setPreferredSize(new Dimension(250, 200));</span>

<span class="fc" id="L66">        numeroIdField = new TTPCTextField();</span>
<span class="fc" id="L67">        nomField = new TTPCTextField();</span>
<span class="fc" id="L68">        especeField = new TTPCTextField();</span>
<span class="fc" id="L69">        sexeBox = new TTPCComboBox&lt;&gt;(new String[]{&quot;M&quot;, &quot;F&quot;});</span>
<span class="fc" id="L70">        ageSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 100, 1));</span>
<span class="fc" id="L71">        provenanceField = new TTPCTextField();</span>
<span class="fc" id="L72">        descriptionArea = new JTextArea(3, 20);</span>
<span class="fc" id="L73">        JScrollPane descriptionScroll = new JScrollPane(descriptionArea);</span>
        
<span class="fc" id="L75">        addButton = new TTPCButton(&quot;Ajouter animal&quot;);</span>
<span class="fc" id="L76">        addButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L77">        editButton = new TTPCButton(&quot;Modifier la sélection&quot;);</span>
<span class="fc" id="L78">        editButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L79">        deleteButton = new TTPCButton(&quot;Supprimer la sélection&quot;);</span>
<span class="fc" id="L80">        deleteButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L81">        voirMouvementsButton = new TTPCButton(&quot;Voir les mouvements&quot;);</span>
<span class="fc" id="L82">        voirMouvementsButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
        
<span class="fc" id="L84">        formPanel.add(new JLabel(&quot;Numéro d'identification :&quot;)); formPanel.add(numeroIdField);</span>
<span class="fc" id="L85">        formPanel.add(new JLabel(&quot;Nom :&quot;)); formPanel.add(nomField);</span>
<span class="fc" id="L86">        formPanel.add(new JLabel(&quot;Espèce :&quot;)); formPanel.add(especeField);</span>
<span class="fc" id="L87">        formPanel.add(new JLabel(&quot;Sexe :&quot;)); formPanel.add(sexeBox);</span>
<span class="fc" id="L88">        formPanel.add(new JLabel(&quot;Âge :&quot;)); formPanel.add(ageSpinner);</span>
<span class="fc" id="L89">        formPanel.add(new JLabel(&quot;Provenance (Nom, qualité et adresse du fournisseur) :&quot;)); formPanel.add(provenanceField);</span>
<span class="fc" id="L90">        formPanel.add(new JLabel(&quot;Description (Race, robe, poils, taille,signes particuliers) :&quot;)); formPanel.add(descriptionScroll);</span>

<span class="fc" id="L92">        configurerAgeSpinner();</span>
        
<span class="fc" id="L94">        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));</span>
<span class="fc" id="L95">        buttonPanel.add(addButton);</span>
<span class="fc" id="L96">        buttonPanel.add(editButton);</span>
<span class="fc" id="L97">        buttonPanel.add(deleteButton);</span>
<span class="fc" id="L98">        buttonPanel.add(voirMouvementsButton);</span>
<span class="fc" id="L99">        buttonPanel.setLayout(new GridLayout(1, 0, 10, 10));</span>
<span class="fc" id="L100">        buttonPanel.setMaximumSize(new Dimension(Integer.MAX_VALUE, 150));</span>
<span class="fc" id="L101">        buttonPanel.setPreferredSize(new Dimension(buttonPanel.getPreferredSize().width, 75));</span>

<span class="fc" id="L103">        formPanel.setBackground(blueColor);</span>
<span class="fc" id="L104">        buttonPanel.setBackground(blueColor);</span>
<span class="fc" id="L105">        formWrapper = new JPanel();</span>
<span class="fc" id="L106">        formWrapper.setLayout(new BoxLayout(formWrapper, BoxLayout.Y_AXIS));</span>
<span class="fc" id="L107">        formWrapper.add(formPanel);</span>
<span class="fc" id="L108">        formWrapper.add(buttonPanel);</span>
        

        // === Table ===
<span class="fc" id="L112">        String[] cols = {&quot;ID&quot;,&quot;Numero d'identification&quot;, &quot;Nom&quot;, &quot;Espèce&quot;, &quot;Sexe&quot;, &quot;Âge&quot;, &quot;Provenance&quot;, &quot;Description&quot;, &quot;Décédé ?&quot;,&quot; Présent ?&quot;};</span>
<span class="fc" id="L113">        tableModel = new DefaultTableModel(cols, 0) {</span>
<span class="nc" id="L114">            public boolean isCellEditable(int row, int col) { return false; }</span>
        };

<span class="fc" id="L117">        table = new JTable(tableModel);</span>
<span class="fc" id="L118">        table.setRowHeight(24);</span>
<span class="fc" id="L119">        table.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 13));</span>
<span class="fc" id="L120">        sorter = new TableRowSorter&lt;&gt;(tableModel);</span>
<span class="fc" id="L121">        table.setRowSorter(sorter);</span>
<span class="fc" id="L122">        JScrollPane scroll = new JScrollPane(table);</span>
<span class="fc" id="L123">        table.getColumnModel().getColumn(0).setMinWidth(0);</span>
<span class="fc" id="L124">        table.getColumnModel().getColumn(0).setMaxWidth(0);</span>
<span class="fc" id="L125">        table.getColumnModel().getColumn(0).setPreferredWidth(0);</span>

        
<span class="fc" id="L128">        searchField = new TTPCTextField();</span>
<span class="fc" id="L129">        toggleFormButton = new JButton(&quot;▼ Cacher le formulaire&quot;);</span>
<span class="fc" id="L130">        toggleFormButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L131">            boolean visible = formWrapper.isVisible();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            formWrapper.setVisible(!visible);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            toggleFormButton.setText(visible ? &quot;▶ Afficher le formulaire&quot; : &quot;▼ Cacher le formulaire&quot;);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            SwingUtilities.invokeLater(() -&gt; splitPane.setDividerLocation(visible ? 0.0 : 0.3));</span>
<span class="nc" id="L135">        });</span>

<span class="fc" id="L137">        JPanel topTableBar = new JPanel(new BorderLayout());</span>
<span class="fc" id="L138">        topTableBar.add(toggleFormButton, BorderLayout.WEST);</span>
<span class="fc" id="L139">        topTableBar.add(searchField, BorderLayout.CENTER);</span>

<span class="fc" id="L141">        JPanel tableButtonBar = new JPanel(new FlowLayout(FlowLayout.RIGHT));</span>
<span class="fc" id="L142">        importButton = new JButton(&quot;Importer CSV&quot;);</span>
<span class="fc" id="L143">        exportButton = new JButton(&quot;Exporter CSV&quot;);</span>
<span class="fc" id="L144">        tableButtonBar.add(importButton);</span>
<span class="fc" id="L145">        tableButtonBar.add(exportButton);</span>

<span class="fc" id="L147">        JPanel tableArea = new JPanel(new BorderLayout());</span>
<span class="fc" id="L148">        tableArea.add(topTableBar, BorderLayout.NORTH);</span>
<span class="fc" id="L149">        tableArea.add(scroll, BorderLayout.CENTER);</span>
<span class="fc" id="L150">        tableArea.add(tableButtonBar, BorderLayout.SOUTH);</span>

<span class="fc" id="L152">        splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, formWrapper, tableArea);</span>
<span class="fc" id="L153">        splitPane.setResizeWeight(0.3);</span>
<span class="fc" id="L154">        splitPane.setOneTouchExpandable(true);</span>

<span class="fc" id="L156">        add(splitPane, BorderLayout.CENTER);</span>

        // Listeners
<span class="fc" id="L159">        searchField.getDocument().addDocumentListener(new javax.swing.event.DocumentListener() {</span>
<span class="nc" id="L160">            public void insertUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
<span class="nc" id="L161">            public void removeUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
<span class="nc" id="L162">            public void changedUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
        });

<span class="pc" id="L165">        addButton.addActionListener(e -&gt; ajouterAnimal());</span>
<span class="pc" id="L166">        editButton.addActionListener(e -&gt; modifierSelection());</span>
<span class="pc" id="L167">        deleteButton.addActionListener(e -&gt; supprimerSelection());</span>
<span class="pc" id="L168">        importButton.addActionListener(e -&gt; importerCSV());</span>
<span class="pc" id="L169">        exportButton.addActionListener(e -&gt; exporterCSV());</span>
<span class="fc" id="L170">        voirMouvementsButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L171">            int row = table.getSelectedRow();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (row &gt;= 0) {</span>
<span class="nc" id="L173">            	int modelIndex = table.convertRowIndexToModel(row);</span>
<span class="nc" id="L174">            	int id = (int) tableModel.getValueAt(modelIndex, 0);</span>
<span class="nc" id="L175">                Animal a = dbManager.getAnimalById(id);</span>
<span class="nc" id="L176">                System.out.println(&quot;ID sélectionné : &quot; + id);</span>
<span class="nc" id="L177">                System.out.println(&quot;Animal récupéré : &quot; + a);</span>
<span class="nc" id="L178">                System.out.println(&quot;Animal : &quot; + a.getId() + &quot; - &quot; + a.getNom());</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">                if (a != null) {</span>
<span class="nc" id="L181">                    afficherMouvementsAnimal(a);</span>
                } else {
<span class="nc" id="L183">                    JOptionPane.showMessageDialog(this, &quot;Animal introuvable.&quot;, &quot;Erreur&quot;, JOptionPane.ERROR_MESSAGE);</span>
                }
<span class="nc" id="L185">            } else {</span>
<span class="nc" id="L186">                JOptionPane.showMessageDialog(this, &quot;Veuillez sélectionner un animal.&quot;, &quot;Avertissement&quot;, JOptionPane.WARNING_MESSAGE);</span>
            }
<span class="nc" id="L188">        });</span>

<span class="fc" id="L190">        updateAnimalTable(this.dbManager.getTousLesAnimaux());</span>
<span class="fc" id="L191">    }</span>

    private void applyFilter() {
<span class="nc" id="L194">        String query = searchField.getText();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        sorter.setRowFilter(query.isEmpty() ? null : RowFilter.regexFilter(&quot;(?i)&quot; + query));</span>
<span class="nc" id="L196">    }</span>

    public Animal getAnimalFormData() {
<span class="nc" id="L199">    	String numeroId = numeroIdField.getText().trim();</span>
<span class="nc" id="L200">        String nom = nomField.getText().trim();</span>
<span class="nc" id="L201">        String espece = especeField.getText().trim();</span>
<span class="nc" id="L202">        char sexe = ((String) sexeBox.getSelectedItem()).charAt(0);</span>
<span class="nc" id="L203">        int age = (int) ageSpinner.getValue();</span>
<span class="nc" id="L204">        String provenance = provenanceField.getText().trim();</span>
<span class="nc" id="L205">        String description = descriptionArea.getText().trim();</span>

<span class="nc bnc" id="L207" title="All 6 branches missed.">        if (nom.isEmpty() || espece.isEmpty() || numeroId.isEmpty()) {</span>
<span class="nc" id="L208">            showMessage(&quot;Nom, espèce et identifiant sont obligatoires.&quot;);</span>
<span class="nc" id="L209">            return null;</span>
        }
        
//        System.out.println(&quot;AnimalPanel GetAnimalFormData&quot;);
//        System.out.println(new Animal(numeroId, nom, espece, sexe, age, provenance, description).toString());

<span class="nc" id="L215">        return new Animal(numeroId, nom, espece, sexe, age, provenance, description);</span>
    }

    public void updateAnimalTable(List&lt;Animal&gt; animaux) {
    	//System.out.println(&quot;updateAnimalTable&quot;);
<span class="fc" id="L220">        tableModel.setRowCount(0);</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        for (Animal a : animaux) {</span>
        	// System.out.println(a.toStringLong());
<span class="nc" id="L223">            tableModel.addRow(new Object[]{</span>
<span class="nc" id="L224">            	a.getId(),</span>
<span class="nc" id="L225">                a.getNumeroId(),</span>
<span class="nc" id="L226">                a.getNom(),</span>
<span class="nc" id="L227">                a.getEspece(),</span>
<span class="nc" id="L228">                a.getSexe(),</span>
<span class="nc" id="L229">                a.getAge(),</span>
<span class="nc" id="L230">                a.getProvenance(),</span>
<span class="nc" id="L231">                a.getDescription(),</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                a.isDecede() ? &quot;Vrai&quot; : &quot;Faux&quot;,</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                a.isPresent(dbManager) ? &quot;Oui&quot; : &quot;Non&quot;</span>
            });
<span class="nc" id="L235">        }</span>
<span class="fc" id="L236">    }</span>

    private void importerCSV() {
<span class="nc" id="L239">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L240">        chooser.setDialogTitle(&quot;Importer un fichier CSV&quot;);</span>
<span class="nc" id="L241">        chooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter(&quot;Fichiers CSV&quot;, &quot;csv&quot;));</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L244">            File file = chooser.getSelectedFile();</span>

<span class="nc" id="L246">            try (BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(file), &quot;UTF-8&quot;))) {</span>
                String line;
<span class="nc" id="L248">                boolean firstLine = true;</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">                while ((line = br.readLine()) != null) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                    if (firstLine) {</span>
<span class="nc" id="L252">                        firstLine = false; // sauter la ligne d'entête</span>
<span class="nc" id="L253">                        continue;</span>
                    }

<span class="nc" id="L256">                    String[] parts = line.split(&quot;,&quot;, -1); // -1 pour ne pas ignorer les colonnes vides</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">                    if (parts.length &gt;= 9) {</span>
<span class="nc" id="L259">                        String numeroId = parts[1].trim();</span>
<span class="nc" id="L260">                        String nom = parts[2].trim();</span>
<span class="nc" id="L261">                        String espece = parts[3].trim();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                        char sexe = parts[4].trim().isEmpty() ? 'M' : parts[4].trim().charAt(0);</span>
<span class="nc" id="L263">                        int age = Integer.parseInt(parts[5].trim());</span>
<span class="nc" id="L264">                        String provenance = parts[6].trim();</span>
<span class="nc" id="L265">                        String description = parts[7].trim();</span>
<span class="nc bnc" id="L266" title="All 4 branches missed.">                        boolean decede = parts[8].trim().equalsIgnoreCase(&quot;oui&quot;) || parts[8].trim().equalsIgnoreCase(&quot;true&quot;);</span>

<span class="nc" id="L268">                        Animal a = new Animal(numeroId, nom, espece, sexe, age, provenance, description, decede);</span>
<span class="nc" id="L269">                        dbManager.ajouterAnimal(a);</span>
                    }
<span class="nc" id="L271">                }</span>

<span class="nc" id="L273">                updateAnimalTable(dbManager.getTousLesAnimaux());</span>
<span class="nc" id="L274">                JOptionPane.showMessageDialog(this, &quot;Import terminé avec succès.&quot;, &quot;Succès&quot;, JOptionPane.INFORMATION_MESSAGE);</span>

<span class="nc" id="L276">            } catch (IOException e) {</span>
<span class="nc" id="L277">            	showMessage(&quot;Erreur : &quot; + e.getMessage());</span>
<span class="nc" id="L278">            }</span>
        }
<span class="nc" id="L280">    }</span>

    private void exporterCSV() {
<span class="nc" id="L283">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L284">        chooser.setDialogTitle(&quot;Exporter les animaux en CSV&quot;);</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (chooser.showSaveDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L287">            File file = chooser.getSelectedFile();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (!file.getName().toLowerCase().endsWith(&quot;.csv&quot;)) {</span>
<span class="nc" id="L289">                file = new File(file.getAbsolutePath() + &quot;.csv&quot;);</span>
            }

<span class="nc" id="L292">            try (PrintWriter pw = new PrintWriter(file, &quot;UTF-8&quot;)) {</span>
                // En-têtes CSV
<span class="nc" id="L294">                pw.println(&quot;ID,Numéro ID,Nom,Espèce,Sexe,Âge,Provenance,Description,Décédé&quot;);</span>

                // Données
<span class="nc bnc" id="L297" title="All 2 branches missed.">                for (int i = 0; i &lt; table.getRowCount(); i++) {</span>
<span class="nc" id="L298">                    StringBuilder line = new StringBuilder();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                    for (int j = 0; j &lt; table.getColumnCount(); j++) {</span>
<span class="nc" id="L300">                        Object val = table.getValueAt(i, j);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                        line.append(val != null ? val.toString().replace(&quot;,&quot;, &quot; &quot;) : &quot;&quot;);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                        if (j &lt; table.getColumnCount() - 1) line.append(&quot;,&quot;);</span>
                    }
<span class="nc" id="L304">                    pw.println(line);</span>
                }

<span class="nc" id="L307">                JOptionPane.showMessageDialog(this, &quot;Export CSV terminé :\n&quot; + file.getAbsolutePath(), &quot;Succès&quot;, JOptionPane.INFORMATION_MESSAGE);</span>

<span class="nc" id="L309">            } catch (IOException e) {</span>
<span class="nc" id="L310">            	showMessage(&quot;Erreur : &quot; + e.getMessage());</span>
<span class="nc" id="L311">            }</span>
        }
<span class="nc" id="L313">    }</span>

    private void afficherMouvementsAnimal(Animal animal) {
<span class="nc" id="L316">        List&lt;Mouvement&gt; mouvements = dbManager.getMouvementsParAnimal(animal.getId());</span>

<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (mouvements.isEmpty()) {</span>
<span class="nc" id="L319">            JOptionPane.showMessageDialog(this,</span>
                    &quot;Pas de mouvements enregistrés&quot;
                );
            
<span class="nc" id="L323">            return;</span>
        };

<span class="nc" id="L326">        String[] colonnes = {&quot;Type&quot;, &quot;Date&quot;, &quot;Décédé&quot;, &quot;Destination / Provenance&quot;};</span>
<span class="nc" id="L327">        Object[][] donnees = new Object[mouvements.size()][4];</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">        for (int i = 0; i &lt; mouvements.size(); i++) {</span>
<span class="nc" id="L330">            Mouvement m = mouvements.get(i);</span>
<span class="nc" id="L331">            donnees[i][0] = m.getTypeMouvement();</span>
<span class="nc" id="L332">            donnees[i][1] = m.getDateMouvement();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            donnees[i][2] = m.isDecede() ? &quot;Oui&quot; : &quot;Non&quot;;</span>
<span class="nc" id="L334">            donnees[i][3] = m.getDestination();</span>
        }

<span class="nc" id="L337">        JTable table = new JTable(donnees, colonnes);</span>

<span class="nc" id="L339">        TTPCDialogMouvement dialog = new TTPCDialogMouvement(</span>
<span class="nc" id="L340">        	    &quot;Mouvements de : &quot; + animal.getNom(),</span>
        	    table,
        	    600,
        	    350
        	);
<span class="nc" id="L345">        	dialog.setVisible(true);</span>

<span class="nc" id="L347">    }</span>

    public void clearForm() {
<span class="nc" id="L350">    	numeroIdField.setText(&quot;&quot;);</span>
<span class="nc" id="L351">        nomField.setText(&quot;&quot;);</span>
<span class="nc" id="L352">        especeField.setText(&quot;&quot;);</span>
<span class="nc" id="L353">        sexeBox.setSelectedIndex(0);</span>
<span class="nc" id="L354">        ageSpinner.setValue(0);</span>
<span class="nc" id="L355">        provenanceField.setText(&quot;&quot;);</span>
<span class="nc" id="L356">        descriptionArea.setText(&quot;&quot;);</span>
<span class="nc" id="L357">        numeroIdField.setText(&quot;&quot;);</span>
<span class="nc" id="L358">    }</span>

    public void showMessage(String msg) {
<span class="nc" id="L361">        JOptionPane.showMessageDialog(this, msg);</span>
<span class="nc" id="L362">    }</span>
    
    private void ajouterAnimal() {
    	//System.out.println(&quot;AnimalPanel ajouterAnimal&quot;);
<span class="nc" id="L366">    	String numero = numeroIdField.getText().trim();</span>
        //System.out.println(&quot;Panel numero: &quot; + numero);
<span class="nc" id="L368">        String nom = nomField.getText().trim();</span>
        // A GARDER - Evite les lignes vides lors de l'ajout
<span class="nc bnc" id="L370" title="All 4 branches missed.">        if (nom.isEmpty() || numero.isEmpty()) {</span>
<span class="nc" id="L371">        	showMessage(&quot;Nom et identifiant sont obligatoires.&quot;);</span>
<span class="nc" id="L372">            return;</span>
        }
<span class="nc" id="L374">        String espece = especeField.getText().trim();</span>
<span class="nc" id="L375">        String sexe = (String) sexeBox.getSelectedItem();</span>
<span class="nc" id="L376">        int age = (Integer) ageSpinner.getValue();</span>
<span class="nc" id="L377">        String provenance = provenanceField.getText().trim();</span>
<span class="nc" id="L378">        String description = descriptionArea.getText().trim();</span>


        
<span class="nc" id="L382">        Animal animal = new Animal(numero, nom, espece, sexe.charAt(0), age, provenance, description);</span>
        //System.out.println(&quot;DEBUG &gt;&gt;&gt; Animal après insertion : &quot; + animal);

<span class="nc" id="L385">        dbManager.ajouterAnimal(animal);</span>
<span class="nc" id="L386">        System.out.println(&quot;ID Animal : &quot; + animal.getId());</span>
<span class="nc" id="L387">        clearForm();</span>
<span class="nc" id="L388">        updateAnimalTable(dbManager.getTousLesAnimaux());</span>
<span class="nc" id="L389">        MainFrame.updateMouvementComboBox();</span>
<span class="nc" id="L390">    }</span>
 
    private void modifierSelection() {
<span class="nc" id="L393">        int row = table.getSelectedRow();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (row == -1) {</span>
<span class="nc" id="L395">            showMessage(&quot;Sélectionnez un animal.&quot;);</span>
<span class="nc" id="L396">            return;</span>
        }

<span class="nc" id="L399">        int modelRow = table.convertRowIndexToModel(row);</span>
<span class="nc" id="L400">        int id = (int) tableModel.getValueAt(modelRow, 0);</span>
<span class="nc" id="L401">        String numeroId = String.valueOf(id); // ou utilise id directement si c'est ce que tu veux</span>
<span class="nc" id="L402">        String nom = (String) tableModel.getValueAt(modelRow, 1);</span>
<span class="nc" id="L403">        String espece = (String) tableModel.getValueAt(modelRow, 2);</span>
<span class="nc" id="L404">        String sexe = tableModel.getValueAt(modelRow, 3).toString();</span>
<span class="nc" id="L405">        int age = (int) tableModel.getValueAt(modelRow, 4);</span>
<span class="nc" id="L406">        String provenance = (String) tableModel.getValueAt(modelRow, 5);</span>
<span class="nc" id="L407">        String description = (String) tableModel.getValueAt(modelRow, 6);</span>
<span class="nc" id="L408">        boolean decede = &quot;Oui&quot;.equals(tableModel.getValueAt(modelRow, 7));</span>

<span class="nc" id="L410">        JTextField numeroIdField = new JTextField(numeroId);</span>
<span class="nc" id="L411">        JTextField nomField = new JTextField(nom);</span>
<span class="nc" id="L412">        JTextField especeField = new JTextField(espece);</span>
<span class="nc" id="L413">        JComboBox&lt;String&gt; sexeBox = new JComboBox&lt;&gt;(new String[]{&quot;M&quot;, &quot;F&quot;});</span>
<span class="nc" id="L414">        sexeBox.setSelectedItem(sexe);</span>
<span class="nc" id="L415">        JSpinner ageSpinner = ageSpinner = new JSpinner(new SpinnerNumberModel(age, 0, 100, 1));</span>
<span class="nc" id="L416">        JTextField provenanceField = new JTextField(provenance);</span>
<span class="nc" id="L417">        JTextArea descriptionArea = new JTextArea(description, 3, 20);</span>
<span class="nc" id="L418">        JScrollPane descScroll = new JScrollPane(descriptionArea);</span>
<span class="nc" id="L419">        JCheckBox decedeBox = new JCheckBox(&quot;Décédé&quot;, decede);</span>

<span class="nc" id="L421">        JPanel panel = new JPanel(new GridLayout(0, 2, 10, 10));</span>
<span class="nc" id="L422">        panel.add(new JLabel(&quot;Numéro d'identification :&quot;)); panel.add(numeroIdField);</span>
<span class="nc" id="L423">        panel.add(new JLabel(&quot;Nom :&quot;)); panel.add(nomField);</span>
<span class="nc" id="L424">        panel.add(new JLabel(&quot;Espèce :&quot;)); panel.add(especeField);</span>
<span class="nc" id="L425">        panel.add(new JLabel(&quot;Sexe :&quot;)); panel.add(sexeBox);</span>
<span class="nc" id="L426">        panel.add(new JLabel(&quot;Âge :&quot;)); panel.add(ageSpinner);</span>
<span class="nc" id="L427">        panel.add(new JLabel(&quot;Provenance :&quot;)); panel.add(provenanceField);</span>
<span class="nc" id="L428">        panel.add(new JLabel(&quot;Description :&quot;)); panel.add(descScroll);</span>
<span class="nc" id="L429">        panel.add(new JLabel(&quot;&quot;)); panel.add(decedeBox);</span>

<span class="nc" id="L431">        int res = JOptionPane.showConfirmDialog(this, panel, &quot;Modifier Animal&quot;, JOptionPane.OK_CANCEL_OPTION);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (res == JOptionPane.OK_OPTION) {</span>
            try {
<span class="nc" id="L434">                int newAge = (Integer) ageSpinner.getValue();</span>
<span class="nc" id="L435">                Animal a = new Animal(numeroIdField.getText().trim(), nomField.getText().trim(), especeField.getText().trim(), </span>
<span class="nc" id="L436">                                      ((String) sexeBox.getSelectedItem()).charAt(0), newAge,</span>
<span class="nc" id="L437">                                      provenanceField.getText().trim(), descriptionArea.getText().trim(),</span>
<span class="nc" id="L438">                                      decedeBox.isSelected());</span>
<span class="nc" id="L439">                dbManager.updateAnimal(a);</span>
<span class="nc" id="L440">                updateAnimalTable(dbManager.getTousLesAnimaux());</span>
<span class="nc" id="L441">                showMessage(&quot;Animal modifié !&quot;);</span>
<span class="nc" id="L442">                MainFrame.updateMouvementComboBox();</span>
<span class="nc" id="L443">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L444">                showMessage(&quot;Âge invalide.&quot;);</span>
<span class="nc" id="L445">            }</span>
        }
<span class="nc" id="L447">    }</span>
    
    private void supprimerSelection() {
<span class="nc" id="L450">        int row = table.getSelectedRow();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (row == -1) {</span>
<span class="nc" id="L452">            JOptionPane.showMessageDialog(this, &quot;Veuillez sélectionner un animal à supprimer.&quot;, &quot;Avertissement&quot;, JOptionPane.WARNING_MESSAGE);</span>
<span class="nc" id="L453">            return;</span>
        }

<span class="nc" id="L456">        int modelRow = table.convertRowIndexToModel(row);</span>
<span class="nc" id="L457">        int id = (int) tableModel.getValueAt(modelRow, 0); // ID en première colonne</span>

<span class="nc" id="L459">        int confirm = JOptionPane.showConfirmDialog(</span>
            this,
            &quot;Êtes-vous sûr de vouloir supprimer cet animal ?&quot;,
            &quot;Confirmation&quot;,
            JOptionPane.YES_NO_OPTION
        );

<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (confirm == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L467">        	dbManager.supprimerAnimalEtMouvements(id);</span>
<span class="nc" id="L468">            updateAnimalTable(dbManager.getTousLesAnimaux());</span>
<span class="nc" id="L469">            MainFrame.updateMouvementComboBox();</span>
<span class="nc" id="L470">            MainFrame.getMouvementPanelInstance().updateMouvementTable(); // mise à jour mouvements</span>
<span class="nc" id="L471">            JOptionPane.showMessageDialog(this, &quot;Animal supprimé avec succès.&quot;);</span>
        }
<span class="nc" id="L473">    }</span>

    // Empecher les lettres et caracteres speciaux dans le agespinner
    private void configurerAgeSpinner() {
<span class="fc" id="L477">        JFormattedTextField txt = ((JSpinner.DefaultEditor) ageSpinner.getEditor()).getTextField();</span>
<span class="fc" id="L478">        ((AbstractDocument) txt.getDocument()).setDocumentFilter(new DocumentFilter() {</span>
            @Override
            public void insertString(FilterBypass fb, int offset, String string, AttributeSet attr) throws BadLocationException {
<span class="nc bnc" id="L481" title="All 2 branches missed.">                if (string.matches(&quot;\\d+&quot;)) {</span>
<span class="nc" id="L482">                    super.insertString(fb, offset, string, attr);</span>
                }
<span class="nc" id="L484">            }</span>

            @Override
            public void replace(FilterBypass fb, int offset, int length, String string, AttributeSet attr) throws BadLocationException {
<span class="nc bnc" id="L488" title="All 2 branches missed.">                if (string.matches(&quot;\\d*&quot;)) {</span>
<span class="nc" id="L489">                    super.replace(fb, offset, length, string, attr);</span>
                }
<span class="nc" id="L491">            }</span>
        });
<span class="fc" id="L493">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>