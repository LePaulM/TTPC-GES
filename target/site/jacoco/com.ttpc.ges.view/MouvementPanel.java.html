<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MouvementPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TTPC-GES</a> &gt; <a href="index.source.html" class="el_package">com.ttpc.ges.view</a> &gt; <span class="el_source">MouvementPanel.java</span></div><h1>MouvementPanel.java</h1><pre class="source lang-java linenums">package com.ttpc.ges.view;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;
import javax.swing.text.MaskFormatter;

import com.ttpc.ges.components.TTPCButton;
import com.ttpc.ges.components.TTPCComboBox;
import com.ttpc.ges.components.TTPCDialogMouvement;
import com.ttpc.ges.components.TTPCFormattedTextField;
import com.ttpc.ges.components.TTPCTextField;
import com.ttpc.ges.model.Animal;
import com.ttpc.ges.model.DatabaseManager;
import com.ttpc.ges.model.Mouvement;
import com.ttpc.ges.utils.TTPCDateParser;

import java.awt.*;
import java.awt.event.ActionListener;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Date;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

public class MouvementPanel extends JPanel {
    private final DatabaseManager dbManager;
    private TTPCComboBox&lt;Animal&gt; animalComboBox;
    private TTPCComboBox&lt;String&gt; typeBox;
    private JCheckBox decedeCheckBox;
    private TTPCFormattedTextField dateField;
	private TTPCTextField searchField;
	private JTable table;
    private DefaultTableModel tableModel;
    private TableRowSorter&lt;DefaultTableModel&gt; sorter;
    private List&lt;Animal&gt; animaux;
    private JPanel formWrapper;
    private TTPCButton voirMouvementsButton,editButton, addButton, deleteButton;
    private JButton importButton,exportButton,toggleFormButton;
    private JSplitPane splitPane;
    
<span class="fc" id="L52">    private Color blueColor = new Color(188,218,244);</span>

<span class="fc" id="L54">    public MouvementPanel(DatabaseManager dbManager) {</span>
<span class="fc" id="L55">        this.dbManager = dbManager;</span>
<span class="fc" id="L56">        setLayout(new BorderLayout());</span>

        // === Formulaire ===
<span class="fc" id="L59">        JPanel formPanel = new JPanel(new GridLayout(0, 2, 10, 10));</span>
<span class="fc" id="L60">        formPanel.setBorder(BorderFactory.createTitledBorder(&quot;Ajouter un mouvement&quot;));</span>
<span class="fc" id="L61">        formPanel.setPreferredSize(new Dimension(350, 200));</span>

<span class="fc" id="L63">        animalComboBox = new TTPCComboBox&lt;&gt;();</span>
<span class="fc" id="L64">        typeBox = new TTPCComboBox&lt;&gt;(new String[]{&quot;&quot;});</span>
<span class="fc" id="L65">        decedeCheckBox = new JCheckBox(&quot;Décédé&quot;);</span>
<span class="fc" id="L66">        decedeCheckBox.setVisible(false);</span>
<span class="fc" id="L67">        decedeCheckBox.setBackground(blueColor);</span>

<span class="fc" id="L69">        new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="fc" id="L70">		dateField = new TTPCFormattedTextField();</span>

        //  Préremplir avec la date du jour
<span class="fc" id="L73">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="fc" id="L74">        dateField.setText(sdf.format(new java.util.Date()));</span>


<span class="fc" id="L77">        formPanel.add(new JLabel(&quot;Animal :&quot;)); formPanel.add(animalComboBox);</span>
<span class="fc" id="L78">        formPanel.add(new JLabel(&quot;Type :&quot;)); formPanel.add(typeBox);</span>
<span class="fc" id="L79">        formPanel.add(new JLabel(&quot;Date (JJ/MM/AAAA) :&quot;)); formPanel.add(dateField);</span>
<span class="fc" id="L80">        formPanel.add(new JLabel(&quot;&quot;)); formPanel.add(decedeCheckBox);</span>

<span class="fc" id="L82">        addButton = new TTPCButton(&quot;Ajouter&quot;);</span>
<span class="fc" id="L83">        addButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L84">        editButton = new TTPCButton(&quot;Modifier la sélection&quot;);</span>
<span class="fc" id="L85">        editButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L86">        deleteButton = new TTPCButton(&quot;Supprimer la sélection&quot;);</span>
<span class="fc" id="L87">        deleteButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="fc" id="L88">        voirMouvementsButton = new TTPCButton(&quot;Voir tous les mouvements&quot;);</span>
<span class="fc" id="L89">        voirMouvementsButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>

<span class="fc" id="L91">        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));</span>
<span class="fc" id="L92">        buttonPanel.add(addButton);</span>
<span class="fc" id="L93">        buttonPanel.add(editButton);</span>
<span class="fc" id="L94">        buttonPanel.add(deleteButton);</span>
<span class="fc" id="L95">        buttonPanel.add(voirMouvementsButton);</span>

<span class="fc" id="L97">        formPanel.setBackground(blueColor);</span>
<span class="fc" id="L98">        buttonPanel.setBackground(blueColor);</span>
<span class="fc" id="L99">        buttonPanel.setLayout(new GridLayout(1, 0, 10, 10));</span>
<span class="fc" id="L100">        buttonPanel.setMaximumSize(new Dimension(Integer.MAX_VALUE, 150));</span>
<span class="fc" id="L101">        buttonPanel.setPreferredSize(new Dimension(buttonPanel.getPreferredSize().width, 75));</span>


        
<span class="fc" id="L105">        formWrapper = new JPanel();</span>
<span class="fc" id="L106">        formWrapper.setLayout(new BoxLayout(formWrapper, BoxLayout.Y_AXIS));</span>
<span class="fc" id="L107">        formWrapper.add(formPanel);</span>
<span class="fc" id="L108">        formWrapper.add(buttonPanel);</span>

        // === Table ===
<span class="fc" id="L111">        String[] colonnes = {</span>
        	    &quot;ID&quot;, // important pour la suppression
        	    &quot;Nom&quot;, &quot;Espèce&quot;, &quot;Sexe&quot;, &quot;ID Animal&quot;, &quot;Âge&quot;,
        	    &quot;Date Entrée&quot;, &quot;Provenance&quot;,
        	    &quot;Date Sortie&quot;, &quot;Destination&quot;, &quot;Décédé&quot;
        	};

<span class="fc" id="L118">        tableModel = new DefaultTableModel(null, colonnes);</span>

<span class="fc" id="L120">        table = new JTable(tableModel);</span>
<span class="fc" id="L121">        table.setRowHeight(24);</span>
<span class="fc" id="L122">        table.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 13));</span>
<span class="fc" id="L123">        sorter = new TableRowSorter&lt;&gt;(tableModel);</span>
<span class="fc" id="L124">        table.setRowSorter(sorter);</span>
<span class="fc" id="L125">        JScrollPane scroll = new JScrollPane(table);</span>
<span class="fc" id="L126">        table.removeColumn(table.getColumnModel().getColumn(0)); // planque la colonne ID</span>
     // Cacher la colonne ID (colonne 0)
<span class="fc" id="L128">        table.getColumnModel().getColumn(0).setMinWidth(0);</span>
<span class="fc" id="L129">        table.getColumnModel().getColumn(0).setMaxWidth(0);</span>
<span class="fc" id="L130">        table.getColumnModel().getColumn(0).setPreferredWidth(0);</span>
     // Cacher la colonne ID (colonne 1)
<span class="fc" id="L132">        table.getColumnModel().getColumn(1).setMinWidth(0);</span>
<span class="fc" id="L133">        table.getColumnModel().getColumn(1).setMaxWidth(0);</span>
<span class="fc" id="L134">        table.getColumnModel().getColumn(1).setPreferredWidth(0);</span>


<span class="fc" id="L137">        searchField = new TTPCTextField();</span>
<span class="fc" id="L138">        toggleFormButton = new JButton(&quot;▼ Cacher le formulaire&quot;);</span>
<span class="fc" id="L139">        toggleFormButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L140">            boolean visible = formWrapper.isVisible();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            formWrapper.setVisible(!visible);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            toggleFormButton.setText(visible ? &quot;▶ Afficher le formulaire&quot; : &quot;▼ Cacher le formulaire&quot;);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            SwingUtilities.invokeLater(() -&gt; splitPane.setDividerLocation(visible ? 0.0 : 0.3));</span>
<span class="nc" id="L144">        });</span>

<span class="fc" id="L146">        JPanel topTableBar = new JPanel(new BorderLayout());</span>
<span class="fc" id="L147">        topTableBar.add(toggleFormButton, BorderLayout.WEST);</span>
<span class="fc" id="L148">        topTableBar.add(searchField, BorderLayout.CENTER);</span>

<span class="fc" id="L150">        JPanel tableButtonBar = new JPanel(new FlowLayout(FlowLayout.RIGHT));</span>
<span class="fc" id="L151">        importButton = new JButton(&quot;Importer CSV&quot;);</span>
<span class="fc" id="L152">        exportButton = new JButton(&quot;Exporter CSV&quot;);</span>
<span class="fc" id="L153">        tableButtonBar.add(importButton);</span>
<span class="fc" id="L154">        tableButtonBar.add(exportButton);</span>

<span class="fc" id="L156">        JPanel tableArea = new JPanel(new BorderLayout());</span>
<span class="fc" id="L157">        tableArea.add(topTableBar, BorderLayout.NORTH);</span>
<span class="fc" id="L158">        tableArea.add(scroll, BorderLayout.CENTER);</span>
<span class="fc" id="L159">        tableArea.add(tableButtonBar, BorderLayout.SOUTH);</span>

<span class="fc" id="L161">        splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, formWrapper, tableArea);</span>
<span class="fc" id="L162">        splitPane.setResizeWeight(0.3);</span>
<span class="fc" id="L163">        splitPane.setOneTouchExpandable(true);</span>

<span class="fc" id="L165">        add(splitPane, BorderLayout.CENTER);</span>

        // === Listeners ===
<span class="fc" id="L168">        searchField.getDocument().addDocumentListener(new javax.swing.event.DocumentListener() {</span>
<span class="nc" id="L169">            public void insertUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
<span class="nc" id="L170">            public void removeUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
<span class="nc" id="L171">            public void changedUpdate(javax.swing.event.DocumentEvent e) { applyFilter(); }</span>
        });

<span class="pc" id="L174">        addButton.addActionListener(e -&gt; ajouterMouvement());</span>
<span class="fc" id="L175">        editButton.addActionListener(e -&gt; {</span>
			try {
<span class="nc" id="L177">				modifierSelection();</span>
<span class="nc" id="L178">			} catch (ParseException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L180">				showMessage(&quot;Erreur bouton midifier : &quot; + e1.getMessage());</span>
<span class="nc" id="L181">			}</span>
<span class="nc" id="L182">		});</span>
<span class="pc" id="L183">        deleteButton.addActionListener(e -&gt; supprimerSelection());</span>
<span class="pc" id="L184">        importButton.addActionListener(e -&gt; importerCSV());</span>
<span class="pc" id="L185">        exportButton.addActionListener(e -&gt; exporterCSV());</span>
<span class="fc" id="L186">        voirMouvementsButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L187">            Animal selectedAnimal = (Animal) animalComboBox.getSelectedItem();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (selectedAnimal == null) {</span>
<span class="nc" id="L189">                JOptionPane.showMessageDialog(this, &quot;Aucun animal sélectionné.&quot;, &quot;Erreur&quot;, JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L190">                return;</span>
            }

<span class="nc" id="L193">            List&lt;Mouvement&gt; mouvements = dbManager.getMouvementsParAnimal(selectedAnimal.getId());</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (mouvements.isEmpty()) {</span>
<span class="nc" id="L195">                JOptionPane.showMessageDialog(this, &quot;Aucun mouvement trouvé pour cet animal.&quot;, &quot;Information&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc" id="L196">                return;</span>
            }

<span class="nc" id="L199">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L200">            sb.append(&quot;Mouvements de l’animal &quot;).append(selectedAnimal.getNom()).append(&quot; (ID: &quot;).append(selectedAnimal.getNumeroId()).append(&quot;)\n\n&quot;);</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">            for (Mouvement m : mouvements) {</span>
<span class="nc" id="L203">                sb.append(&quot;• &quot;).append(m.getTypeMouvement()).append(&quot; - &quot;).append(m.getDateMouvement());</span>
<span class="nc bnc" id="L204" title="All 4 branches missed.">                if (&quot;sortie&quot;.equalsIgnoreCase(m.getTypeMouvement()) &amp;&amp; m.getDestination() != null) {</span>
<span class="nc" id="L205">                    sb.append(&quot; → &quot;).append(m.getDestination());</span>
                }
<span class="nc" id="L207">                sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L208">            }</span>
<span class="nc" id="L209">            System.out.println(&quot;Mouvements récupérés : &quot; + mouvements.size());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            for (Mouvement m : mouvements) {</span>
<span class="nc" id="L211">                System.out.println(&quot;→ &quot; + m.getTypeMouvement() + &quot; | &quot; + m.getDateMouvement());</span>
<span class="nc" id="L212">            }</span>

<span class="nc" id="L214">            JTextArea textArea = new JTextArea(sb.toString());</span>
<span class="nc" id="L215">            textArea.setEditable(false);</span>
<span class="nc" id="L216">            textArea.setFont(new Font(&quot;Monospaced&quot;, Font.PLAIN, 13));</span>

<span class="nc" id="L218">            JScrollPane scrollPane = new JScrollPane(textArea);</span>
<span class="nc" id="L219">            scrollPane.setPreferredSize(new Dimension(400, 300));</span>

<span class="nc" id="L221">            TTPCDialogMouvement dialog = new TTPCDialogMouvement(</span>
<span class="nc" id="L222">        	    &quot;Mouvements de : &quot; + selectedAnimal.getNom(),</span>
        	    table,
        	    600,
        	    350
        	);
<span class="nc" id="L227">        	dialog.setVisible(true);</span>

<span class="nc" id="L229">        });</span>


        // === Init données ===
<span class="fc" id="L233">        rafraichirListeAnimaux();</span>
<span class="fc" id="L234">        updateMouvementTable();</span>
<span class="fc" id="L235">    }</span>
    
    public static Date parseDateJJMMAAAA(String input) throws ParseException {
<span class="nc" id="L238">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="nc" id="L239">        sdf.setLenient(false); // stricte : 32/13/2025 sera invalide</span>
<span class="nc" id="L240">        java.util.Date parsed = sdf.parse(input);</span>
<span class="nc" id="L241">        return new Date(parsed.getTime()); // java.sql.Date</span>
    }

    private void applyFilter() {
<span class="nc" id="L245">        String txt = searchField.getText();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        sorter.setRowFilter(txt.isEmpty() ? null : RowFilter.regexFilter(&quot;(?i)&quot; + txt));</span>
<span class="nc" id="L247">    }</span>
    
    private void supprimerSelection() {
<span class="nc" id="L250">        int row = table.getSelectedRow();</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (row == -1) {</span>
<span class="nc" id="L252">            showMessage(&quot;Sélectionnez une ligne contenant un mouvement.&quot;);</span>
<span class="nc" id="L253">            return;</span>
        }

<span class="nc" id="L256">        int modelRow = table.convertRowIndexToModel(row);</span>
<span class="nc" id="L257">        Object idEntreeObj = tableModel.getValueAt(modelRow, 0); // ID_Entrée</span>
<span class="nc" id="L258">        Object idSortieObj = tableModel.getValueAt(modelRow, 1); // ID_Sortie</span>
        
<span class="nc bnc" id="L260" title="All 2 branches missed.">        boolean hasEntree = idEntreeObj != null;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        boolean hasSortie = idSortieObj != null;</span>

<span class="nc bnc" id="L263" title="All 4 branches missed.">        if (!hasEntree &amp;&amp; !hasSortie) {</span>
<span class="nc" id="L264">            showMessage(&quot;Aucun mouvement associé à cette ligne.&quot;);</span>
<span class="nc" id="L265">            return;</span>
        }

<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (hasEntree &amp;&amp; hasSortie) {</span>
<span class="nc" id="L269">            String[] choix = {&quot;Supprimer l'entrée&quot;, &quot;Supprimer la sortie&quot;, &quot;Annuler&quot;};</span>
<span class="nc" id="L270">            int reponse = JOptionPane.showOptionDialog(</span>
                this,
                &quot;L’animal a une entrée et une sortie. Que souhaitez-vous supprimer ?&quot;,
                &quot;Suppression ciblée&quot;,
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.QUESTION_MESSAGE,
                null,
                choix,
                choix[0]
            );

<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (reponse == 0) { // Supprimer l'entrée</span>
<span class="nc" id="L282">                dbManager.deleteMouvement(Integer.parseInt(idEntreeObj.toString()));</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            } else if (reponse == 1) { // Supprimer la sortie</span>
<span class="nc" id="L284">                dbManager.deleteMouvement(Integer.parseInt(idSortieObj.toString()));</span>
            }

<span class="nc bnc" id="L287" title="All 2 branches missed.">        } else if (hasEntree) {</span>
<span class="nc" id="L288">        	int idEntree = Integer.parseInt(idEntreeObj.toString());</span>
<span class="nc" id="L289">            int confirm = JOptionPane.showConfirmDialog(</span>
                this,
                &quot;Supprimer cette entrée ?&quot;,
                &quot;Confirmation&quot;,
                JOptionPane.YES_NO_OPTION
            );
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (confirm == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L296">                dbManager.deleteMouvement(idEntree);</span>
            }

<span class="nc bnc" id="L299" title="All 2 branches missed.">        } else if (hasSortie) {</span>
<span class="nc" id="L300">        	int idSortie = Integer.parseInt(idSortieObj.toString());</span>
<span class="nc" id="L301">            int confirm = JOptionPane.showConfirmDialog(</span>
                this,
                &quot;Supprimer cette sortie ?&quot;,
                &quot;Confirmation&quot;,
                JOptionPane.YES_NO_OPTION
            );
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (confirm == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L308">                dbManager.deleteMouvement(idSortie);</span>
            }
        }

<span class="nc" id="L312">        updateMouvementTable();</span>
<span class="nc" id="L313">        showMessage(&quot;Mise à jour effectuée.&quot;);</span>
<span class="nc" id="L314">    }</span>

    public void rafraichirListeAnimaux() {
<span class="fc" id="L317">        animalComboBox.removeAllItems();</span>
<span class="fc" id="L318">        animaux = dbManager.getTousLesAnimaux();</span>
        
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        for (Animal a : animaux) {</span>
<span class="nc" id="L321">            animalComboBox.addItem(a); // si Animal.toString() affiche bien le nom</span>
<span class="nc" id="L322">        }</span>

<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (!animaux.isEmpty()) {</span>
<span class="nc" id="L325">            animalComboBox.setSelectedIndex(0);</span>
<span class="nc" id="L326">            updateTypeOptions();</span>
        }

<span class="pc" id="L329">        animalComboBox.addItemListener(e -&gt; updateTypeOptions());</span>
<span class="fc" id="L330">    }</span>

    private void updateTypeOptions() {
    	//System.out.println(&quot;UpdateTypeOptions&quot;);
<span class="nc" id="L334">        typeBox.removeAllItems();</span>
        //System.out.println(&quot;selected item : &quot; + animalComboBox.getSelectedItem());
        //tring nom = (String) animalComboBox.getSelectedItem().toString();
<span class="nc" id="L337">        Animal a = (Animal) animalComboBox.getSelectedItem();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (a == null) return;</span>

<span class="nc" id="L340">        List&lt;Mouvement&gt; mouvements = dbManager.getMouvementsParAnimal(a.getId());</span>
        // System.out.println(&quot;mouvements : &quot; + mouvements);
<span class="nc bnc" id="L342" title="All 4 branches missed.">        if (mouvements.isEmpty() || !&quot;entrée&quot;.equalsIgnoreCase(mouvements.get(mouvements.size() - 1).getTypeMouvement())) {</span>
<span class="nc" id="L343">            typeBox.addItem(&quot;entrée&quot;);</span>
        } else {
<span class="nc" id="L345">            typeBox.addItem(&quot;sortie&quot;);</span>
        }

<span class="nc" id="L348">        decedeCheckBox.setVisible(&quot;sortie&quot;.equalsIgnoreCase((String) typeBox.getSelectedItem()));</span>
<span class="nc" id="L349">    }</span>

    private void ajouterMouvement() {
<span class="nc" id="L352">        Animal animal = (Animal) animalComboBox.getSelectedItem();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (animal == null) {</span>
<span class="nc" id="L354">            showMessage(&quot;Veuillez sélectionner un animal.&quot;);</span>
<span class="nc" id="L355">            return;</span>
        }

<span class="nc" id="L358">        String type = ((String) typeBox.getSelectedItem()).toLowerCase();</span>
<span class="nc" id="L359">        String dateStr = dateField.getText().trim();</span>
<span class="nc" id="L360">        Date sqlDate = null;</span>
        try {
<span class="nc" id="L362">			sqlDate = TTPCDateParser.stringToSqlDate(dateStr);</span>
<span class="nc" id="L363">            System.out.println(&quot;Date SQL : &quot; + sqlDate);</span>
<span class="nc" id="L364">        } catch (Exception e) {</span>
<span class="nc" id="L365">            System.out.println(&quot;Erreur de format : &quot; + e.getMessage());</span>
<span class="nc" id="L366">        }</span>
        
<span class="nc" id="L368">        boolean estDecede = decedeCheckBox.isSelected();</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (dateStr.contains(&quot;_&quot;)) {</span>
<span class="nc" id="L371">            showMessage(&quot;Veuillez compléter la date.&quot;);</span>
<span class="nc" id="L372">            return;</span>
        }

        // Préremplir la destination avec la provenance de l’animal
<span class="nc bnc" id="L376" title="All 2 branches missed.">        String defaultDestination = animal.getProvenance() != null ? animal.getProvenance() : &quot;&quot;;</span>
<span class="nc" id="L377">        String destination = JOptionPane.showInputDialog(</span>
            this,
            &quot;Destination / provenance :&quot;,
            defaultDestination
        );

<span class="nc bnc" id="L383" title="All 4 branches missed.">        if (destination == null || destination.trim().isEmpty()) {</span>
<span class="nc" id="L384">            showMessage(&quot;La destination est requise.&quot;);</span>
<span class="nc" id="L385">            return;</span>
        }

<span class="nc" id="L388">        Mouvement m = new Mouvement(animal.getId(), type, sqlDate, destination.trim(), estDecede);</span>
<span class="nc" id="L389">        dbManager.ajouterMouvement(m);</span>
<span class="nc" id="L390">        updateMouvementTable();</span>
<span class="nc" id="L391">        showMessage(&quot;Mouvement ajouté avec succès.&quot;);</span>
<span class="nc" id="L392">    }</span>

    public Mouvement getMouvementFormData() {
        // méthode exposée pour le controller si besoin
<span class="nc" id="L396">        return null; // à implémenter selon l'usage</span>
    }

    public boolean isDecedeCoche() {
<span class="nc bnc" id="L400" title="All 4 branches missed.">        return decedeCheckBox.isVisible() &amp;&amp; decedeCheckBox.isSelected();</span>
    }

    public void updateMouvementTable() {
<span class="fc" id="L404">        List&lt;Mouvement&gt; mouvements = dbManager.getTousLesMouvements();</span>
<span class="fc" id="L405">        String[] colonnes = {</span>
            &quot;ID_Entrée&quot;, &quot;ID_Sortie&quot;, &quot;Nom&quot;, &quot;Espèce&quot;, &quot;Sexe&quot;, &quot;ID Animal&quot;, &quot;Âge&quot;,
            &quot;Date Entrée&quot;, &quot;Provenance&quot;, &quot;Date Sortie&quot;, &quot;Destination&quot;, &quot;Décédé&quot;
        };

<span class="fc" id="L410">        tableModel.setDataVector(new Object[0][0], colonnes);</span>

        // Regrouper les mouvements par animal
<span class="fc" id="L413">        Map&lt;Integer, Mouvement&gt; entrees = new HashMap&lt;&gt;();</span>
<span class="fc" id="L414">        Map&lt;Integer, Mouvement&gt; sorties = new HashMap&lt;&gt;();</span>

<span class="pc bpc" id="L416" title="1 of 2 branches missed.">        for (Mouvement m : mouvements) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (&quot;entrée&quot;.equalsIgnoreCase(m.getTypeMouvement())) {</span>
<span class="nc" id="L418">                entrees.put(m.getAnimalId(), m);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">            } else if (&quot;sortie&quot;.equalsIgnoreCase(m.getTypeMouvement())) {</span>
<span class="nc" id="L420">                sorties.put(m.getAnimalId(), m);</span>
            }
<span class="nc" id="L422">        }</span>

<span class="fc" id="L424">        Set&lt;Integer&gt; allAnimalIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L425">        allAnimalIds.addAll(entrees.keySet());</span>
<span class="fc" id="L426">        allAnimalIds.addAll(sorties.keySet());</span>

<span class="pc bpc" id="L428" title="1 of 2 branches missed.">        for (int animalId : allAnimalIds) {</span>
<span class="nc" id="L429">            Animal a = dbManager.getAnimalById(animalId);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (a == null) {</span>
<span class="nc" id="L431">                System.out.println(&quot;Animal introuvable pour animalId=&quot; + animalId);</span>
<span class="nc" id="L432">                continue;</span>
            }

<span class="nc" id="L435">            Mouvement entree = entrees.get(animalId);</span>
<span class="nc" id="L436">            Mouvement sortie = sorties.get(animalId);</span>

<span class="nc" id="L438">            Object[] ligne = new Object[]{</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                entree != null ? entree.getId() : null,</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                sortie != null ? sortie.getId() : null,</span>
<span class="nc" id="L441">                a.getNom(), a.getEspece(), a.getSexe(), a.getNumeroId(), a.getAge(),</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                entree != null ? entree.getDateMouvement().toString() : &quot;&quot;,</span>
<span class="nc" id="L443">                a.getProvenance(),</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">                sortie != null ? sortie.getDateMouvement().toString() : &quot;&quot;,</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                sortie != null ? sortie.getDestination() : &quot;&quot;,</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                a.isDecede() ? &quot;Oui&quot; : &quot;Non&quot;</span>
            };

<span class="nc" id="L449">            tableModel.addRow(ligne);</span>
<span class="nc" id="L450">        }</span>

<span class="fc" id="L452">        table.setModel(tableModel);</span>
     // Cacher les colonnes ID_Entrée (index 0) et ID_Sortie (index 1)
<span class="fc" id="L454">        table.getColumnModel().getColumn(0).setMinWidth(0);</span>
<span class="fc" id="L455">        table.getColumnModel().getColumn(0).setMaxWidth(0);</span>
<span class="fc" id="L456">        table.getColumnModel().getColumn(0).setPreferredWidth(0);</span>

<span class="fc" id="L458">        table.getColumnModel().getColumn(1).setMinWidth(0);</span>
<span class="fc" id="L459">        table.getColumnModel().getColumn(1).setMaxWidth(0);</span>
<span class="fc" id="L460">        table.getColumnModel().getColumn(1).setPreferredWidth(0);</span>

<span class="fc" id="L462">    }</span>

    public void clearForm() {
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (animalComboBox.getItemCount() &gt; 0) {</span>
<span class="nc" id="L466">            animalComboBox.setSelectedIndex(0);</span>
        }
<span class="nc" id="L468">        typeBox.setSelectedIndex(0);</span>
        
        // Met la date du jour
<span class="nc" id="L471">        java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="nc" id="L472">        dateField.setText(sdf.format(new java.util.Date()));</span>

<span class="nc" id="L474">        decedeCheckBox.setSelected(false);</span>
<span class="nc" id="L475">        decedeCheckBox.setVisible(false);</span>
<span class="nc" id="L476">    }</span>

    public void showMessage(String msg) {
<span class="nc" id="L479">        JOptionPane.showMessageDialog(this, msg);</span>
<span class="nc" id="L480">    }</span>

    public void addAddMouvementListener(ActionListener listener) {
<span class="fc" id="L483">        addButton.addActionListener(listener);</span>
<span class="fc" id="L484">    }</span>
    
    private void modifierSelection() throws ParseException {
<span class="nc" id="L487">        int row = table.getSelectedRow();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (row == -1) {</span>
<span class="nc" id="L489">            showMessage(&quot;Sélectionnez une ligne.&quot;);</span>
<span class="nc" id="L490">            return;</span>
        }

<span class="nc" id="L493">        int modelRow = table.convertRowIndexToModel(row);</span>
<span class="nc" id="L494">        Object idEntreeObj = tableModel.getValueAt(modelRow, 0);</span>
<span class="nc" id="L495">        Object idSortieObj = tableModel.getValueAt(modelRow, 1);</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">        boolean hasEntree = idEntreeObj != null;</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        boolean hasSortie = idSortieObj != null;</span>

<span class="nc bnc" id="L500" title="All 4 branches missed.">        if (!hasEntree &amp;&amp; !hasSortie) {</span>
<span class="nc" id="L501">            showMessage(&quot;Aucun mouvement sélectionné.&quot;);</span>
<span class="nc" id="L502">            return;</span>
        }

<span class="nc" id="L505">        String[] options = {&quot;Modifier l'entrée&quot;, &quot;Modifier la sortie&quot;, &quot;Annuler&quot;};</span>
<span class="nc" id="L506">        int choix = 0;</span>

<span class="nc bnc" id="L508" title="All 4 branches missed.">        if (hasEntree &amp;&amp; hasSortie) {</span>
<span class="nc" id="L509">            choix = JOptionPane.showOptionDialog(</span>
                this,
                &quot;Quel mouvement souhaitez-vous modifier ?&quot;,
                &quot;Modifier un mouvement&quot;,
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.QUESTION_MESSAGE,
                null,
                options,
                options[0]
            );
<span class="nc bnc" id="L519" title="All 2 branches missed.">            if (choix == 2) return;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        } else if (hasSortie) {</span>
<span class="nc" id="L521">            choix = 1;</span>
        }

<span class="nc bnc" id="L524" title="All 2 branches missed.">        int id = choix == 0</span>
<span class="nc" id="L525">            ? Integer.parseInt(idEntreeObj.toString())</span>
<span class="nc" id="L526">            : Integer.parseInt(idSortieObj.toString());</span>

<span class="nc" id="L528">        Mouvement m = dbManager.getMouvementById(id);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L530">            showMessage(&quot;Mouvement introuvable.&quot;);</span>
<span class="nc" id="L531">            return;</span>
        }

<span class="nc" id="L534">        JTextField dateField = new JTextField(m.getDateMouvement().toString());</span>
<span class="nc" id="L535">        JCheckBox decedeBox = new JCheckBox(&quot;Décédé&quot;, m.isDecede());</span>
<span class="nc" id="L536">        JTextField destinationField = new JTextField(m.getDestination());</span>
<span class="nc bnc" id="L537" title="All 4 branches missed.">        if (hasEntree &amp;&amp; !hasSortie) {</span>
<span class="nc" id="L538">        	destinationField = new JTextField(dbManager.getAnimalById(m.getAnimalId()).getProvenance());</span>
        } 
        

<span class="nc" id="L542">        JPanel panel = new JPanel(new GridLayout(0, 2, 10, 10));</span>
<span class="nc" id="L543">        panel.add(new JLabel(&quot;Date (JJ/MM/AAAA) :&quot;)); panel.add(dateField);</span>
<span class="nc" id="L544">        panel.add(new JLabel(&quot;Décédé ?&quot;)); panel.add(decedeBox);</span>
<span class="nc" id="L545">        panel.add(new JLabel(&quot;Destination / provenance :&quot;)); panel.add(destinationField);</span>

<span class="nc" id="L547">        int res = JOptionPane.showConfirmDialog(this, panel, &quot;Modifier Mouvement&quot;, JOptionPane.OK_CANCEL_OPTION);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (res == JOptionPane.OK_OPTION) {</span>
<span class="nc" id="L549">            String date = dateField.getText().trim();</span>
<span class="nc" id="L550">            boolean decede = decedeBox.isSelected();</span>
<span class="nc" id="L551">            String destination = destinationField.getText().trim();</span>

<span class="nc bnc" id="L553" title="All 4 branches missed.">            if (date.isEmpty() || destination.isEmpty()) {</span>
<span class="nc" id="L554">                showMessage(&quot;Champs requis.&quot;);</span>
<span class="nc" id="L555">                return;</span>
            }

<span class="nc" id="L558">            Mouvement updated = new Mouvement(m.getAnimalId(), m.getTypeMouvement(), TTPCDateParser.stringToSqlDate(date), destination, decede);</span>
<span class="nc" id="L559">            updated.setId(m.getId());</span>
<span class="nc" id="L560">            dbManager.updateMouvement(updated);</span>

<span class="nc" id="L562">            updateMouvementTable();</span>
<span class="nc" id="L563">            showMessage(&quot;Mouvement modifié !&quot;);</span>
        }
<span class="nc" id="L565">    }</span>
    
    public static java.sql.Date parseDateSafely(String input) {
<span class="nc bnc" id="L568" title="All 4 branches missed.">        if (input == null || input.trim().isEmpty()) return null;</span>

<span class="nc" id="L570">        input = input.trim();</span>
<span class="nc" id="L571">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="nc" id="L572">        sdf.setLenient(false);</span>

        try {
            // Si c’est une vraie date JJ/MM/AAAA
<span class="nc" id="L576">            java.util.Date parsed =  sdf.parse(input);</span>
<span class="nc" id="L577">            return new java.sql.Date(parsed.getTime());</span>

<span class="nc" id="L579">        } catch (ParseException e) {</span>
            try {
                // Sinon, essaie de le parser comme un timestamp
<span class="nc" id="L582">                long timestamp = Long.parseLong(input);</span>
<span class="nc" id="L583">                return new java.sql.Date(timestamp);</span>
<span class="nc" id="L584">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L585">                System.out.println(&quot;Erreur parsing date : \&quot;&quot; + input + &quot;\&quot; n'est ni une date ni un timestamp.&quot;);</span>
<span class="nc" id="L586">                return null;</span>
            }
        }
    }

    private void importerCSV() {
<span class="nc" id="L592">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L593">        chooser.setDialogTitle(&quot;Importer mouvements depuis un fichier CSV&quot;);</span>
<span class="nc" id="L594">        chooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter(&quot;Fichiers CSV&quot;, &quot;csv&quot;));</span>

<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L597">            File file = chooser.getSelectedFile();</span>
<span class="nc" id="L598">            int imported = 0;</span>

<span class="nc" id="L600">            try (BufferedReader br = new BufferedReader(new FileReader(file))) {</span>
                String line;
<span class="nc" id="L602">                boolean isFirstLine = true;</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">                while ((line = br.readLine()) != null) {</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                    if (isFirstLine) {</span>
<span class="nc" id="L606">                        isFirstLine = false;</span>
<span class="nc" id="L607">                        continue;</span>
                    }

<span class="nc" id="L610">                    String[] parts = line.split(&quot;,&quot;, -1); // garder les champs vides</span>

<span class="nc bnc" id="L612" title="All 2 branches missed.">                    if (parts.length &lt; 11) continue;</span>

                    try {
                        // Colonne &quot;ID Animal&quot; (numeroId)
<span class="nc" id="L616">                        String numeroId = parts[5].trim();</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                        if (numeroId.isEmpty()) continue;</span>

<span class="nc" id="L619">                        Animal a = dbManager.getAnimalByNumeroId(numeroId);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">                        if (a == null) {</span>
<span class="nc" id="L621">                            System.out.println(&quot;Animal introuvable : &quot; + numeroId);</span>
<span class="nc" id="L622">                            continue;</span>
                        }

<span class="nc" id="L625">                        int animalId = a.getId();</span>

                        // Entrée
<span class="nc" id="L628">                        String dateEntreeStr = parts[7].trim();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">                        if (!dateEntreeStr.isEmpty()) {</span>
<span class="nc" id="L630">                            Date dateEntree = TTPCDateParser.stringToSqlDate(dateEntreeStr);</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                            if (dateEntree != null) {</span>
<span class="nc" id="L632">                                Mouvement entree = new Mouvement(animalId, &quot;entrée&quot;, dateEntree, parts[8].trim(), false);</span>
<span class="nc" id="L633">                                dbManager.ajouterMouvement(entree);</span>
<span class="nc" id="L634">                                System.out.println(&quot;Entrée ajoutée pour animal ID &quot; + animalId);</span>
<span class="nc" id="L635">                                imported++;</span>
<span class="nc" id="L636">                            } else {</span>
<span class="nc" id="L637">                                System.out.println(&quot;→ Date entrée invalide : &quot; + dateEntreeStr);</span>
                            }
                        }

                        // Sortie
<span class="nc" id="L642">                        String dateSortieStr = parts[9].trim();</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                        if (!dateSortieStr.isEmpty()) {</span>
<span class="nc" id="L644">                            Date dateSortie = TTPCDateParser.stringToSqlDate(dateSortieStr);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">                            if (dateSortie != null) {</span>
<span class="nc bnc" id="L646" title="All 4 branches missed.">                                boolean decede = parts.length &gt; 11 &amp;&amp; parts[11].trim().equalsIgnoreCase(&quot;oui&quot;);</span>
<span class="nc" id="L647">                                Mouvement sortie = new Mouvement(animalId, &quot;sortie&quot;, dateSortie, parts[10].trim(), decede);</span>
<span class="nc" id="L648">                                dbManager.ajouterMouvement(sortie);</span>
<span class="nc" id="L649">                                dbManager.mettreAJourStatutDeces(animalId, decede);</span>
<span class="nc" id="L650">                                System.out.println(&quot;Sortie ajoutée pour animal ID &quot; + animalId);</span>
<span class="nc" id="L651">                                imported++;</span>
<span class="nc" id="L652">                            } else {</span>
<span class="nc" id="L653">                                System.out.println(&quot;→ Date sortie invalide : &quot; + dateSortieStr);</span>
                            }
                        }

<span class="nc" id="L657">                    } catch (Exception ex) {</span>
<span class="nc" id="L658">                        System.out.println(&quot;Erreur ligne CSV : &quot; + ex.getMessage());</span>
                        // continue sans planter
<span class="nc" id="L660">                    }</span>
<span class="nc" id="L661">                }</span>

<span class="nc" id="L663">                updateMouvementTable();</span>
<span class="nc" id="L664">                showMessage(imported + &quot; mouvements importés avec succès.&quot;);</span>

<span class="nc" id="L666">            } catch (IOException e) {</span>
<span class="nc" id="L667">                showMessage(&quot;Erreur lecture fichier : &quot; + e.getMessage());</span>
<span class="nc" id="L668">            }</span>
        }
<span class="nc" id="L670">    }</span>


    private void exporterCSV() {
<span class="nc" id="L674">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L675">        chooser.setDialogTitle(&quot;Exporter les mouvements en CSV&quot;);</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (chooser.showSaveDialog(this) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L678">            File file = chooser.getSelectedFile();</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            if (!file.getName().endsWith(&quot;.csv&quot;)) {</span>
<span class="nc" id="L680">                file = new File(file.getAbsolutePath() + &quot;.csv&quot;);</span>
            }

<span class="nc" id="L683">            try (PrintWriter pw = new PrintWriter(file)) {</span>
                // En-têtes
<span class="nc bnc" id="L685" title="All 2 branches missed.">                for (int i = 0; i &lt; tableModel.getColumnCount(); i++) {</span>
<span class="nc" id="L686">                    pw.print(tableModel.getColumnName(i));</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                    if (i &lt; tableModel.getColumnCount() - 1) pw.print(&quot;,&quot;);</span>
                }
<span class="nc" id="L689">                pw.println();</span>

                // Données
<span class="nc bnc" id="L692" title="All 2 branches missed.">                for (int row = 0; row &lt; tableModel.getRowCount(); row++) {</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                    for (int col = 0; col &lt; tableModel.getColumnCount(); col++) {</span>
<span class="nc" id="L694">                        Object val = tableModel.getValueAt(row, col);</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                        pw.print(val != null ? val.toString() : &quot;&quot;);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                        if (col &lt; tableModel.getColumnCount() - 1) pw.print(&quot;,&quot;);</span>
                    }
<span class="nc" id="L698">                    pw.println();</span>
                }
<span class="nc" id="L700">            } catch (IOException e) {</span>
<span class="nc" id="L701">                showMessage(&quot;Erreur export CSV : &quot; + e.getMessage());</span>
<span class="nc" id="L702">            }</span>
        }
<span class="nc" id="L704">    }</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>